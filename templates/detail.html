{% extends "base.html" %}
{% block content %}

{% macro date_view(v) -%}
  {%- if v in [None, ""] -%}\{%- else -%}
    {%- if v.__class__.__name__ in ["date","datetime"] -%}
      {{ v.strftime("%Y-%m-%d") }}
    {%- else -%}
      {{ (v|string)[:10] }}
    {%- endif -%}
  {%- endif -%}
{%- endmacro %}


<section class="card" style="max-width:1200px; margin:0 auto;">
  <div class="card__hd" style="flex-wrap:wrap; gap:8px;">
    <div class="card__title">{{ table_label }} · 详情（ID：{{ id_ }}）</div>
    <div class="card__sub">密集布局 · 显示全部字段</div>
  </div>
  <div class="card__bd">

    {% if ok %}
      <div style="background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46;padding:8px 10px;border-radius:10px;margin-bottom:12px;">
        ✅ 已保存
      </div>
    {% endif %}
    {% if err %}
      <div style="background:#fef2f2;border:1px solid #fecaca;color:#991b1b;padding:8px 10px;border-radius:10px;margin-bottom:12px;">
        ❌ 操作失败（请检查字段格式或主键）
      </div>
    {% endif %}

    <!-- 顶部操作条 -->
    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px;">
      {% if not edit %}
        <a class="btn" href="/detail/{{ table }}/{{ id_ }}?edit=1">编辑</a>
        <a class="btn btn--danger" href="/detail/{{ table }}/{{ id_ }}?delete=1">删除</a>
      {% endif %}
      <a class="btn btn--ghost" href="/view/{{ table }}">返回列表</a>
      <a class="btn btn--ghost" href="/add">新增记录</a>
    </div>

    {% if delete_confirm and not edit %}
      <div style="background:#fef2f2;border:1px solid #fecaca;color:#7f1d1d;padding:8px 10px;border-radius:10px;margin-bottom:12px;">
        ⚠️ 确认要删除该记录吗？此操作不可恢复。
        <form method="post" action="/detail/{{ table }}/{{ id_ }}/delete" style="display:inline-block; margin-left:10px;">
          <button class="btn btn--danger btn--sm" type="submit">确认删除</button>
        </form>
        <a class="btn btn--ghost btn--sm" href="/detail/{{ table }}/{{ id_ }}" style="margin-left:6px;">取消</a>
      </div>
    {% endif %}

    {% if not edit %}
      <!-- 只读：双列 KV 密集网格 -->
    {% set date_labels = ["发布出让公告时间","成交日期","合同签订日期","付款截止日期","实际付款日期"] %}
    <div class="kv-grid">
      {% for label, value in items %}
        <div class="kv-key">{{ label }}</div>
        <div class="kv-val">
          {% if label in date_labels %}
            {{ date_view(value) }}
          {% else %}
            {{ value if value not in [None, ""] else "\\" }}
          {% endif %}
        </div>
      {% endfor %}
    </div>


    {% else %}
      <!-- 编辑：同样的网格，但右列是输入控件 -->
      <form method="post" action="/detail/{{ table }}/{{ id_ }}/update" class="kv-grid">
        <!-- ID 只读 -->
        <div class="kv-key">ID</div>
        <div class="kv-val"><input class="input" value="{{ record['id'] }}" readonly /></div>

        {% set fields = ['name','region','mineral_type','area','quantity','recommendations','coordinates','transfer_conditions','announcement_date','annual_transfer_batch','proj_source','start_price','transaction_date','transaction_price','payable_price','success_bidder','contact_name','social_credit_code','contact_number','company_address','transfer_authority','contract_number','contract_signing_date','payment_deadline','actual_payment_date'] %}

        {% for col in fields %}
          <div class="kv-key">{{ FIELD_LABELS[col] if FIELD_LABELS is defined and FIELD_LABELS.get(col) else col }}</div>
          <div class="kv-val">
            {% set val = record[col] if record[col] is not none else '' %}
            {% if col in ['announcement_date','transaction_date','contract_signing_date','payment_deadline','actual_payment_date'] %}
              <input class="input" type="date" name="{{ col }}" value="{{ val }}" />
            {% elif col in ['area','start_price','transaction_price','payable_price'] %}
              <input class="input" type="number" step="any" name="{{ col }}" value="{{ val }}" />
            {% else %}
              <input class="input" name="{{ col }}" value="{{ val }}" />
            {% endif %}
          </div>
        {% endfor %}

        <div></div>
        <div style="display:flex; gap:10px; margin-top:8px;">
          <button class="btn" type="submit">保存</button>
          <a class="btn btn--ghost" href="/detail/{{ table }}/{{ id_ }}">取消</a>
        </div>
      </form>
    {% endif %}
  </div>
</section>

{% endblock %}